<div class="appointments-container">
  <div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1>Appointments</h1>
        <p class="text-muted">Manage and schedule patient appointments</p>
      </div>
      @if (user && user.role === 'PATIENT') {
        <button class="btn btn-primary" (click)="openCreateModal()">
          <i class="fas fa-plus me-2"></i>New Appointment
        </button>
      }
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4">
    <div class="col-md-6 col-lg-3">
      <div class="stat-card">
        <div class="stat-icon dashboard">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-content">
          <h3>{{ stats.total }}</h3>
          <p>Total Appointments</p>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3">
      <div class="stat-card">
        <div class="stat-icon appointments">
          <i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-content">
          <h3>{{ stats.today }}</h3>
          <p>Today's Appointments</p>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3">
      <div class="stat-card">
        <div class="stat-icon pending">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ stats.pending }}</h3>
          <p>Pending</p>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3">
      <div class="stat-card">
        <div class="stat-icon completed">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ stats.completed }}</h3>
          <p>Completed</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="row g-4 mt-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-search me-2"></i>Search
                </label>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search by patient, doctor, or type..."
                  [(ngModel)]="searchTerm">
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-filter me-2"></i>Status
                </label>
                <select class="form-select" [(ngModel)]="statusFilter">
                  <option value="all">All Status</option>
                  <option value="pending_approval">Pending Approval</option>
                  <option value="accepted">Accepted</option>
                  <option value="scheduled">Scheduled</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                  <option value="denied">Denied</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-calendar me-2"></i>Date Range
                </label>
                <select class="form-select" [(ngModel)]="dateFilter">
                  <option value="all">All Dates</option>
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                </select>
              </div>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button
                class="btn btn-outline-secondary w-100"
                (click)="searchTerm = ''; statusFilter = 'all'; dateFilter = 'all'">
                <i class="fas fa-redo me-2"></i>Reset
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Appointments Table -->
  <div class="row g-4 mt-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5>Appointments List</h5>
            <span class="text-muted">{{ filteredAppointments.length }} appointment(s) found</span>
          </div>
        </div>
        <div class="card-body">
          @if (filteredAppointments.length === 0) {
            <div class="empty-state">
              <i class="fas fa-calendar-times"></i>
              <h4>No appointments found</h4>
              <p>Try adjusting your filters or create a new appointment</p>
            </div>
          } @else {
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    @if (user && user.role !== 'PATIENT') {
                      <th>Patient</th>
                    }
                    @if (user && user.role !== 'DOCTOR') {
                      <th>Doctor</th>
                    }
                    <th>Date</th>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Status</th>
                    @if (user && user.role === 'ADMIN') {
                      <th>Message</th>
                    }
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (appointment of filteredAppointments; track appointment.id) {
                    <tr>
                      @if (user && user.role !== 'PATIENT') {
                        <td>
                          <div class="d-flex align-items-center">
                            <div class="patient-avatar">{{ appointment.patientInitials }}</div>
                            <div class="ms-2">
                              <div class="fw-bold">{{ appointment.patientName }}</div>
                              <div class="text-muted small">{{ appointment.phone }}</div>
                            </div>
                          </div>
                        </td>
                      }
                      @if (user && user.role !== 'DOCTOR') {
                        <td>{{ appointment.doctor }}</td>
                      }
                      <td>
                        <div>{{ appointment.date }}</div>
                      </td>
                      <td>{{ appointment.time }}</td>
                      <td>{{ appointment.type }}</td>
                      <td>
                        <span class="badge" [ngClass]="getStatusBadgeClass(appointment.status)">
                          {{ getStatusText(appointment.status) }}
                        </span>
                      </td>
                      @if (user && user.role === 'ADMIN') {
                        <td>
                          @if (appointment.cancellationMessage) {
                            <button
                              class="btn btn-sm btn-outline-info"
                              (click)="openMessageModal(appointment)"
                              title="View Cancellation Message">
                              <i class="fas fa-comment-alt"></i>
                            </button>
                          }
                        </td>
                      }
                      <td>
                        <div class="action-buttons">
                          <!-- Admin Actions -->
                          @if (user && user.role === 'ADMIN') {
                            @if (appointment.status === 'pending_approval') {
                              <button
                                class="btn btn-sm btn-success"
                                (click)="acceptAppointment(appointment)"
                                title="Accept">
                                <i class="fas fa-check"></i>
                              </button>
                              <button
                                class="btn btn-sm btn-danger"
                                (click)="denyAppointment(appointment)"
                                title="Deny">
                                <i class="fas fa-times"></i>
                              </button>
                            }
                          }

                          <!-- Doctor Actions -->
                          @if (user && user.role === 'DOCTOR') {
                            @if (canCancelAppointment(appointment)) {
                              <button
                                class="btn btn-sm btn-outline-danger"
                                (click)="openCancelModal(appointment)"
                                title="Cancel Appointment">
                                <i class="fas fa-ban"></i>
                              </button>
                            }
                          }

                          <!-- Patient Actions -->
                          @if (user && user.role === 'PATIENT') {
                            <button
                              class="btn btn-sm btn-outline-primary"
                              [disabled]="!canEditAppointment(appointment)"
                              (click)="openEditModal(appointment)"
                              [title]="canEditAppointment(appointment) ? 'Edit Appointment' : 'Cannot edit - appointment time has passed or is not editable'">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button
                              class="btn btn-sm btn-outline-danger"
                              [disabled]="!canCancelAppointment(appointment)"
                              (click)="openCancelModal(appointment)"
                              [title]="canCancelAppointment(appointment) ? 'Cancel Appointment' : 'Cannot cancel - appointment time has passed or is not cancellable'">
                              <i class="fas fa-times"></i>
                            </button>
                          }
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Appointment Modal -->
@if (showModal) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ modalMode === 'create' ? 'Create New Appointment' : 'Edit Appointment' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Patient Name *</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="formData.patientName"
                name="patientName"
                [readonly]="user ? user.role === 'PATIENT' : false"
                [disabled]="user ? user.role === 'PATIENT' : false"
                [placeholder]="user && user.role === 'PATIENT' ? (user.name || 'Enter patient name') : 'Enter patient name'"
                required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Doctor *</label>
              <select
                class="form-select"
                [(ngModel)]="formData.doctorId"
                name="doctorId"
                (change)="onDoctorChange()"
                required>
                <option [value]="0">Select Doctor</option>
                @for (doctor of doctors; track doctor.id) {
                  <option [value]="doctor.id">{{ doctor.name }}@if (doctor.consultationFee) { - ${{ doctor.consultationFee }}}</option>
                }
              </select>
              @if (loadingDoctors) {
                <small class="text-muted">Loading doctors...</small>
              }
              @if (doctors.length === 0 && !loadingDoctors) {
                <small class="text-warning">No doctors available. Please add doctors first.</small>
              }
            </div>
                  <div class="col-md-6">
                    <label class="form-label">Date *</label>
                    <input
                      type="date"
                      class="form-control"
                      [(ngModel)]="formData.date"
                      name="date"
                      [min]="minDate"
                      (change)="onDateChange()"
                      required>
                    <small class="text-muted">Cannot select past dates</small>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Time *</label>
                    <select
                      class="form-select"
                      [(ngModel)]="formData.time"
                      name="time"
                      required>
                      <option value="">Select Time</option>
                      @for (time of clinicHours; track time) {
                        <option [value]="time">{{ formatTimeForDisplay(time) }}</option>
                      }
                    </select>
                    <small class="text-muted">Clinic hours: 9:00 AM - 9:00 PM</small>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Reason/Type *</label>
                    <select
                      class="form-select"
                      [(ngModel)]="formData.reason"
                      name="reason"
                      required>
                      <option value="">Select Appointment Reason</option>
                      @for (reason of appointmentReasons; track reason) {
                        <option [value]="reason">{{ reason }}</option>
                      }
                    </select>
                    <small class="text-muted">Select the reason for this appointment</small>
                  </div>
                          @if (user && user.role === 'ADMIN') {
              <div class="col-md-6">
                <label class="form-label">Status *</label>
                <select
                  class="form-select"
                  [(ngModel)]="formData.status"
                  name="status"
                  required>
                  <option value="pending_approval">Pending Approval</option>
                  <option value="accepted">Accepted</option>
                  <option value="scheduled">Scheduled</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                  <option value="denied">Denied</option>
                </select>
              </div>
            }
            <div class="col-md-6">
              <label class="form-label">Payment Method *</label>
              <select
                class="form-select"
                [(ngModel)]="formData.paymentMethod"
                name="paymentMethod"
                required>
                <option value="CASH">Cash (Pay at Clinic)</option>
                <option value="VISA">Visa (Pay Online)</option>
              </select>
              <small class="text-muted">Cash payments require admin approval. Visa payments can be paid online.</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Amount ($) *</label>
              <input
                type="number"
                class="form-control"
                [(ngModel)]="formData.amount"
                name="amount"
                [readonly]="true"
                [value]="formData.amount"
                placeholder="Select doctor to see fee"
                required>
              <small class="text-muted">Amount is calculated based on selected doctor's consultation fee</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input
                type="tel"
                class="form-control"
                [(ngModel)]="formData.phone"
                name="phone">
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                [(ngModel)]="formData.email"
                name="email">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="saveAppointment()">
          {{ modalMode === 'create' ? 'Create' : 'Update' }} Appointment
        </button>
      </div>
    </div>
  </div>
}

<!-- Cancel Appointment Modal -->
@if (showCancelModal) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5 class="modal-title">Cancel Appointment</h5>
        <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        @if (cancellingAppointment) {
          <div class="mb-3">
            <p><strong>Patient:</strong> {{ cancellingAppointment.patientName }}</p>
            <p><strong>Date:</strong> {{ cancellingAppointment.date }}</p>
            <p><strong>Time:</strong> {{ cancellingAppointment.time }}</p>
          </div>
        }
        <div class="form-group">
          <label class="form-label">
            @if (user && user.role === 'DOCTOR') {
              Reason for Cancellation (This message will be sent to admin for review) *
            } @else {
              Reason for Cancellation *
            }
          </label>
          <textarea
            class="form-control"
            rows="4"
            placeholder="Please provide a reason for cancelling this appointment..."
            [(ngModel)]="cancellationForm.message"
            name="cancellationMessage"
            required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeModal()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmCancelAppointment()">
          Confirm Cancellation
        </button>
      </div>
    </div>
  </div>
}

<!-- View Cancellation Message Modal (Admin) -->
@if (showMessageModal && viewingMessageAppointment) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5 class="modal-title">Cancellation Message</h5>
        <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <p><strong>Patient:</strong> {{ viewingMessageAppointment.patientName }}</p>
          <p><strong>Doctor:</strong> {{ viewingMessageAppointment.doctor }}</p>
          <p><strong>Date:</strong> {{ viewingMessageAppointment.date }}</p>
          <p><strong>Time:</strong> {{ viewingMessageAppointment.time }}</p>
          <p><strong>Cancelled By:</strong> {{ viewingMessageAppointment.cancelledBy === 'doctor' ? 'Doctor' : 'Patient' }}</p>
        </div>
        <div class="form-group">
          <label class="form-label"><strong>Cancellation Reason:</strong></label>
          <div class="message-box">
            {{ viewingMessageAppointment.cancellationMessage }}
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="closeModal()">Close</button>
      </div>
    </div>
  </div>
}

