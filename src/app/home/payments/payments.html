<div class="payments-container">
  @if (user) {
    <!-- Admin View -->
    @if (user.role === 'admin') {
      <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1>Today's Payments</h1>
            <p class="text-muted">Manage and track today's payment transactions</p>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="row g-4">
        <div class="col-md-6 col-lg-3">
          <div class="stat-card">
            <div class="stat-icon dashboard">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-content">
              <h3>{{ formatCurrency(adminStats.totalAmount) }}</h3>
              <p>Total Revenue</p>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3">
          <div class="stat-card">
            <div class="stat-icon appointments">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-content">
              <h3>{{ todayPayments.length }}</h3>
              <p>Today's Payments</p>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3">
          <div class="stat-card">
            <div class="stat-icon completed">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
              <h3>{{ adminStats.paid }}</h3>
              <p>Paid</p>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3">
          <div class="stat-card">
            <div class="stat-icon pending">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
              <h3>{{ adminStats.pending }}</h3>
              <p>Pending</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="row g-4 mt-3">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-search me-2"></i>Search
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      placeholder="Search by patient, doctor, or amount..."
                      [(ngModel)]="searchTerm">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-filter me-2"></i>Status
                    </label>
                    <select class="form-select" [(ngModel)]="statusFilter">
                      <option value="all">All Status</option>
                      <option value="paid">Paid</option>
                      <option value="pending">Pending</option>
                      <option value="failed">Failed</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button
                    class="btn btn-outline-secondary w-100"
                    (click)="searchTerm = ''; statusFilter = 'all'">
                    <i class="fas fa-redo me-2"></i>Reset
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payments Table -->
      <div class="row g-4 mt-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h5>Today's Payment Transactions</h5>
                <span class="text-muted">{{ filteredAdminPayments.length }} payment(s) found</span>
              </div>
            </div>
            <div class="card-body">
              @if (filteredAdminPayments.length === 0) {
                <div class="empty-state">
                  <i class="fas fa-credit-card"></i>
                  <h4>No payments found</h4>
                  <p>No payment transactions for today</p>
                </div>
              } @else {
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Patient</th>
                        <th>Doctor</th>
                        <th>Date & Time</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Payment Method</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (payment of filteredAdminPayments; track payment.id) {
                        <tr>
                          <td>
                            <div class="fw-bold">{{ payment.patientName }}</div>
                          </td>
                          <td>{{ payment.doctor }}</td>
                          <td>
                            <div>{{ payment.date }}</div>
                            <div class="text-muted small">{{ payment.time }}</div>
                          </td>
                          <td>
                            <div class="fw-bold text-success">{{ formatCurrency(payment.amount) }}</div>
                          </td>
                          <td>
                            <span class="badge" [ngClass]="getStatusBadgeClass(payment.status)">
                              {{ getStatusText(payment.status) }}
                            </span>
                          </td>
                          <td>
                            @if (payment.cardLast4) {
                              <div>
                                <i class="fas fa-credit-card me-2"></i>
                                **** {{ payment.cardLast4 }}
                              </div>
                            } @else {
                              <span class="text-muted">-</span>
                            }
                          </td>
                          <td>
                            <div class="action-buttons">
                              @if (payment.status === 'pending') {
                                <button
                                  class="btn btn-sm btn-success"
                                  (click)="markAsPaid(payment)"
                                  title="Mark as Paid">
                                  <i class="fas fa-check me-1"></i>Mark Paid
                                </button>
                              }
                            </div>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Doctor View -->
    @else if (user.role === 'doctor') {
      <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1>Payment Statistics</h1>
            <p class="text-muted">View your earnings and payment breakdown</p>
          </div>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row g-4">
        <div class="col-md-6 col-lg-3">
          <div class="stat-card">
            <div class="stat-icon dashboard">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-content">
              <h3>{{ formatCurrency(doctorStats.totalEarnings) }}</h3>
              <p>Total Earnings</p>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3">
          <div class="stat-card">
            <div class="stat-icon completed">
              <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-content">
              <h3>{{ formatCurrency(doctorStats.netEarnings) }}</h3>
              <p>Net Earnings (80%)</p>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3">
          <div class="stat-card">
            <div class="stat-icon pending">
              <i class="fas fa-building"></i>
            </div>
            <div class="stat-content">
              <h3>{{ formatCurrency(doctorStats.clinicTaxTotal) }}</h3>
              <p>Clinic Tax (20%)</p>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3">
          <div class="stat-card">
            <div class="stat-icon appointments">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-content">
              <h3>{{ doctorStats.totalAppointments }}</h3>
              <p>Total Appointments</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Earnings Breakdown -->
      <div class="row g-4 mt-3">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Earnings Breakdown</h5>
            </div>
            <div class="card-body">
              <div class="earnings-breakdown">
                <div class="breakdown-item">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Total Revenue</span>
                    <strong>{{ formatCurrency(doctorStats.totalEarnings) }}</strong>
                  </div>
                  <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-primary" role="progressbar" [style.width.%]="100"></div>
                  </div>
                </div>

                <div class="breakdown-item">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>
                      <i class="fas fa-wallet me-2 text-success"></i>Your Earnings (80%)
                    </span>
                    <strong class="text-success">{{ formatCurrency(doctorStats.netEarnings) }}</strong>
                  </div>
                  <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-success" role="progressbar" [style.width.%]="getPercentage(doctorStats.netEarnings, doctorStats.totalEarnings)"></div>
                  </div>
                </div>

                <div class="breakdown-item">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>
                      <i class="fas fa-building me-2 text-warning"></i>Clinic Tax (20%)
                    </span>
                    <strong class="text-warning">{{ formatCurrency(doctorStats.clinicTaxTotal) }}</strong>
                  </div>
                  <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-warning" role="progressbar" [style.width.%]="getPercentage(doctorStats.clinicTaxTotal, doctorStats.totalEarnings)"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Summary</h5>
            </div>
            <div class="card-body">
              <div class="summary-stats">
                <div class="summary-item">
                  <div class="summary-label">Average per Appointment</div>
                  <div class="summary-value">
                    {{ formatCurrency(doctorStats.totalAppointments > 0 ? doctorStats.totalEarnings / doctorStats.totalAppointments : 0) }}
                  </div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">Average Net Earnings</div>
                  <div class="summary-value text-success">
                    {{ formatCurrency(doctorStats.totalAppointments > 0 ? doctorStats.netEarnings / doctorStats.totalAppointments : 0) }}
                  </div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">Earnings Percentage</div>
                  <div class="summary-value">
                    <span class="badge bg-success">80%</span>
                  </div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">Clinic Tax Percentage</div>
                  <div class="summary-value">
                    <span class="badge bg-warning">20%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="row g-4 mt-3">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-search me-2"></i>Search
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      placeholder="Search by patient, date, or amount..."
                      [(ngModel)]="searchTerm">
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="form-label">
                      <i class="fas fa-calendar me-2"></i>Date Range
                    </label>
                    <select class="form-select" [(ngModel)]="dateFilter">
                      <option value="all">All Time</option>
                      <option value="today">Today</option>
                      <option value="week">Last 7 Days</option>
                      <option value="month">Last Month</option>
                      <option value="year">Last Year</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button
                    class="btn btn-outline-secondary w-100"
                    (click)="searchTerm = ''; dateFilter = 'all'">
                    <i class="fas fa-redo me-2"></i>Reset
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payments Table -->
      <div class="row g-4 mt-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h5>Payment History</h5>
                <span class="text-muted">{{ filteredDoctorPayments.length }} payment(s) found</span>
              </div>
            </div>
            <div class="card-body">
              @if (filteredDoctorPayments.length === 0) {
                <div class="empty-state">
                  <i class="fas fa-credit-card"></i>
                  <h4>No payments found</h4>
                  <p>No payment records match your filters</p>
                </div>
              } @else {
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Patient</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Total Amount</th>
                        <th>Clinic Tax (20%)</th>
                        <th>Your Earnings (80%)</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (payment of filteredDoctorPayments; track payment.id) {
                        <tr>
                          <td>
                            <div class="fw-bold">{{ payment.patientName }}</div>
                          </td>
                          <td>{{ payment.date }}</td>
                          <td>{{ payment.time }}</td>
                          <td>
                            <div class="fw-bold">{{ formatCurrency(payment.amount) }}</div>
                          </td>
                          <td>
                            <div class="text-warning">{{ formatCurrency(payment.clinicTax) }}</div>
                          </td>
                          <td>
                            <div class="fw-bold text-success">{{ formatCurrency(payment.doctorEarning) }}</div>
                          </td>
                          <td>
                            <span class="badge bg-success">Paid</span>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Patient View -->
    @else if (user.role === 'patient') {
      <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1>My Payments</h1>
            <p class="text-muted">Manage your payment methods and pay for appointments</p>
          </div>
          <button class="btn btn-primary" (click)="openCardModal()">
            <i class="fas fa-plus me-2"></i>Add Card
          </button>
        </div>
      </div>

      <!-- Saved Cards -->
      <div class="row g-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>Saved Payment Methods</h5>
            </div>
            <div class="card-body">
              @if (cards.length === 0) {
                <div class="empty-state">
                  <i class="fas fa-credit-card"></i>
                  <h4>No saved cards</h4>
                  <p>Add a card to make payments easier</p>
                </div>
              } @else {
                <div class="row g-3">
                  @for (card of cards; track card.id) {
                    <div class="col-md-6 col-lg-4">
                      <div class="card-item" [class.default-card]="card.isDefault">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                          <div>
                            <div class="fw-bold">{{ card.cardHolder }}</div>
                            <div class="text-muted">{{ maskCardNumber(card.cardNumber) }}</div>
                            <div class="text-muted small">
                              Expires: {{ card.expiryMonth }}/{{ card.expiryYear }}
                            </div>
                          </div>
                          @if (card.isDefault) {
                            <span class="badge bg-primary">Default</span>
                          }
                        </div>
                        <div class="d-flex gap-2">
                          @if (!card.isDefault) {
                            <button
                              class="btn btn-sm btn-outline-primary"
                              (click)="setDefaultCard(card.id)">
                              Set Default
                            </button>
                          }
                          <button
                            class="btn btn-sm btn-outline-danger"
                            (click)="deleteCard(card.id)">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Pending Payments -->
      <div class="row g-4 mt-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>Pending Payments</h5>
            </div>
            <div class="card-body">
              @if (appointments.length === 0) {
                <div class="empty-state">
                  <i class="fas fa-check-circle"></i>
                  <h4>No pending payments</h4>
                  <p>All your appointments are paid</p>
                </div>
              } @else {
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Appointment</th>
                        <th>Doctor</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Amount</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (appointment of appointments; track appointment.id) {
                        <tr>
                          <td>
                            <div class="fw-bold">{{ appointment.type }}</div>
                            <div class="text-muted small">{{ appointment.status }}</div>
                          </td>
                          <td>{{ appointment.doctor }}</td>
                          <td>{{ appointment.date }}</td>
                          <td>{{ appointment.time }}</td>
                          <td>
                            <div class="fw-bold text-primary">{{ formatCurrency(appointment.amount!) }}</div>
                          </td>
                          <td>
                            <button
                              class="btn btn-sm btn-primary"
                              (click)="openPaymentModal(appointment)">
                              <i class="fas fa-credit-card me-1"></i>Pay Now
                            </button>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }
  } @else {
    <div class="alert alert-warning">Please log in to view payments.</div>
  }
</div>

<!-- Add Card Modal (Patient) -->
@if (showCardModal) {
  <div class="modal-overlay" (click)="closeCardModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5 class="modal-title">Add Payment Card</h5>
        <button type="button" class="btn-close" (click)="closeCardModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label class="form-label">Card Number *</label>
            <input
              type="text"
              class="form-control"
              placeholder="1234 5678 9012 3456"
              [(ngModel)]="cardForm.cardNumber"
              name="cardNumber"
              maxlength="19"
              required>
          </div>
          <div class="mb-3">
            <label class="form-label">Card Holder Name *</label>
            <input
              type="text"
              class="form-control"
              placeholder="John Doe"
              [(ngModel)]="cardForm.cardHolder"
              name="cardHolder"
              required>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Expiry Month *</label>
              <select
                class="form-select"
                [(ngModel)]="cardForm.expiryMonth"
                name="expiryMonth"
                required>
                <option value="">MM</option>
                @for (month of [1,2,3,4,5,6,7,8,9,10,11,12]; track month) {
                  <option [value]="month.toString().padStart(2, '0')">
                    {{ month.toString().padStart(2, '0') }}
                  </option>
                }
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Expiry Year *</label>
              <select
                class="form-select"
                [(ngModel)]="cardForm.expiryYear"
                name="expiryYear"
                required>
                <option value="">YYYY</option>
                @for (year of getYears(); track year) {
                  <option [value]="year">{{ year }}</option>
                }
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">CVV *</label>
              <input
                type="text"
                class="form-control"
                placeholder="123"
                [(ngModel)]="cardForm.cvv"
                name="cvv"
                maxlength="4"
                required>
            </div>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="isDefault"
              [(ngModel)]="cardForm.isDefault"
              name="isDefault">
            <label class="form-check-label" for="isDefault">
              Set as default payment method
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeCardModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="saveCard()">Save Card</button>
      </div>
    </div>
  </div>
}

<!-- Payment Modal (Patient) -->
@if (showPaymentModal && selectedAppointment) {
  <div class="modal-overlay" (click)="closePaymentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5 class="modal-title">Process Payment</h5>
        <button type="button" class="btn-close" (click)="closePaymentModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <h6>Appointment Details</h6>
          <div class="payment-summary">
            <div class="d-flex justify-content-between mb-2">
              <span>Doctor:</span>
              <strong>{{ selectedAppointment.doctor }}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Date:</span>
              <strong>{{ selectedAppointment.date }}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Time:</span>
              <strong>{{ selectedAppointment.time }}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Type:</span>
              <strong>{{ selectedAppointment.type }}</strong>
            </div>
            <hr>
            <div class="d-flex justify-content-between">
              <span class="fs-5">Total Amount:</span>
              <strong class="fs-5 text-primary">{{ formatCurrency(selectedAppointment.amount!) }}</strong>
            </div>
          </div>
        </div>

        <form>
          <div class="mb-3">
            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="radio"
                name="paymentMethod"
                id="useExistingCard"
                [checked]="!paymentForm.useNewCard"
                (change)="paymentForm.useNewCard = false">
              <label class="form-check-label" for="useExistingCard">
                Use saved card
              </label>
            </div>
            @if (!paymentForm.useNewCard) {
              <select
                class="form-select"
                [(ngModel)]="paymentForm.cardId"
                name="cardId">
                <option [value]="0">Select a card</option>
                @for (card of cards; track card.id) {
                  <option [value]="card.id">
                    {{ card.cardHolder }} - **** {{ card.last4 }}
                    @if (card.isDefault) {
                      (Default)
                    }
                  </option>
                }
              </select>
            }
          </div>

          <div class="mb-3">
            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="radio"
                name="paymentMethod"
                id="useNewCard"
                [checked]="paymentForm.useNewCard"
                (change)="paymentForm.useNewCard = true">
              <label class="form-check-label" for="useNewCard">
                Use new card
              </label>
            </div>
            @if (paymentForm.useNewCard) {
              <div class="card-form">
                <div class="mb-3">
                  <label class="form-label">Card Number *</label>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="1234 5678 9012 3456"
                    [(ngModel)]="paymentForm.newCard.cardNumber"
                    name="newCardNumber"
                    maxlength="19">
                </div>
                <div class="mb-3">
                  <label class="form-label">Card Holder Name *</label>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="John Doe"
                    [(ngModel)]="paymentForm.newCard.cardHolder"
                    name="newCardHolder">
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Expiry Month *</label>
                    <select
                      class="form-select"
                      [(ngModel)]="paymentForm.newCard.expiryMonth"
                      name="newExpiryMonth">
                      <option value="">MM</option>
                      @for (month of [1,2,3,4,5,6,7,8,9,10,11,12]; track month) {
                        <option [value]="month.toString().padStart(2, '0')">
                          {{ month.toString().padStart(2, '0') }}
                        </option>
                      }
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Expiry Year *</label>
                    <select
                      class="form-select"
                      [(ngModel)]="paymentForm.newCard.expiryYear"
                      name="newExpiryYear">
                      <option value="">YYYY</option>
                      @for (year of getYears(); track year) {
                        <option [value]="year">{{ year }}</option>
                      }
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">CVV *</label>
                    <input
                      type="text"
                      class="form-control"
                      placeholder="123"
                      [(ngModel)]="paymentForm.newCard.cvv"
                      name="newCvv"
                      maxlength="4">
                  </div>
                </div>
              </div>
            }
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closePaymentModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="processPayment()">
          <i class="fas fa-lock me-2"></i>Pay {{ formatCurrency(selectedAppointment.amount!) }}
        </button>
      </div>
    </div>
  </div>
}

